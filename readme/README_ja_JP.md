# Upstage Document Parser

## 概要

Upstage Document Parserは、Upstage APIを活用してPDF、画像、オフィス文書など様々な文書形式からコンテンツを抽出・解析する高度なツールプラグインです。高精度OCRとインテリジェントレイアウト検出機能を提供します。

## 機能

### サポート対象ファイル形式
- **文書**: PDF, DOCX, XLSX, PPTX
- **画像**: JPEG, PNG, BMP, TIFF, HEIC

### 出力形式
- **Markdown**: 構造化されたフォーマット付きテキスト
- **HTML**: Web対応の整形されたコンテンツ
- **プレーンテキスト**: フォーマットなしのクリーンなテキスト

### 高度な機能
- **自動OCR**: インテリジェント文字認識
- **チャート認識**: チャートをテーブルに変換
- **レイアウト検出**: 文書構造を保持
- **多言語サポート**: 様々な言語に対応
- **インテリジェントメモリキャッシュ**: パフォーマンス向上のためのメモリ内キャッシュ

## インストール

1. **APIキーの取得**
   - [Upstage Console](https://console.upstage.ai/api-keys)にアクセス
   - アカウントを作成してAPIキーを生成

2. **プラグインのインストール**
   - `.difypkg`ファイルをDifyインスタンスにアップロード
   - またはDify Plugin Marketplaceからインストール

3. **認証情報の設定**
   - プラグイン設定でUpstage APIキーを入力
   - 接続をテストして正しく設定されていることを確認

## 使用方法

### 基本的な使い方
1. ワークフローに「Upstage Document Parser」ツールを追加
2. ファイル入力をツールに接続
3. 希望する出力形式を選択（markdown/html/text）
4. ワークフローを実行して文書を解析

### パラメータ

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `file` | file | はい | 解析する文書ファイル |
| `output_format` | select | いいえ | 出力形式（markdown, html, text） |

### ワークフロー例

```
[ファイルアップロード] → [Upstage Document Parser] → [テキスト出力]
                              ↓
                    [output_format: markdown]
```

## パフォーマンス最適化

### メモリキャッシュシステム
このプラグインは以下の機能を持つインテリジェントメモリキャッシュを実装しています：
- **APIコスト削減**: 同一ファイルはキャッシュから提供
- **応答時間向上**: キャッシュされた結果は瞬時に返される
- **スマートキャッシュ管理**: 自動期限切れとLRU削除
- **スレッドセーフ**: 適切なロック機能による並行リクエスト処理

### キャッシュ設定
- **キャッシュ期間**: 1時間（3600秒）
- **最大エントリ数**: 100個のキャッシュされた文書
- **キャッシュキー**: ファイル内容のMD5ハッシュ + 出力形式
- **削除戦略**: 最近最少使用（LRU）

## API詳細

このプラグインは以下の設定でUpstage Document Parse API v1を使用します：

- **モデル**: `document-parse`
- **OCRモード**: `auto`（各ファイル形式に最適化）
- **チャート認識**: 有効
- **座標情報**: レイアウト検出のため有効
- **タイムアウト**: 300秒（5分）

## トラブルシューティング

### よくある問題

1. **「無効なAPIキー」**
   - APIキーが正しいことを確認
   - Upstage ConsoleでAPIキーの権限を確認

2. **「コンテンツが抽出されませんでした」**
   - ファイルが破損していないことを確認
   - 異なる出力形式を試す
   - ファイル形式がサポートされているか確認

3. **「APIタイムアウト」**
   - 大きなファイルは処理に時間がかかる場合があります
   - 大きな文書は分割を検討

### サポート

API関連の問題については、[Upstage APIドキュメント](https://console.upstage.ai/api/document-digitization/document-parsing)を参照してください。

## 技術仕様

- **最小Difyバージョン**: 1.5.0
- **プラグインタイプ**: Tool
- **メモリ要件**: 256MB
- **ネットワーク**: Upstage APIへのインターネット接続が必要

## ライセンス

このプラグインはDifyワークフローとの統合のために提供されています。API使用制限についてはUpstageの利用規約を参照してください。